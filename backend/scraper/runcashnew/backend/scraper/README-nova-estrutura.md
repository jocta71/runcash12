# Nova Estrutura de Dados para o Scraper de Roletas

Este documento descreve as mudanças realizadas na estrutura de dados do scraper, migrando de uma tabela `roletas` com arrays para uma tabela `roleta_numeros` mais eficiente.

## Resumo das Alterações

As principais alterações incluem:

1. **Eliminação da tabela `roletas`**: A tabela antiga foi removida, e agora todos os números das roletas são armazenados na nova tabela `roleta_numeros`.

2. **Nova Estrutura de Tabela**: Cada número extraído das roletas é armazenado como um registro individual na tabela `roleta_numeros`, permitindo consultas mais eficientes.

3. **Limitação Automática**: Um trigger foi implementado para manter apenas 1000 números mais recentes para cada roleta, evitando crescimento excessivo da tabela.

4. **Atualização do Scraper**: O código foi modificado para interagir exclusivamente com a nova tabela.

## Tabela `roleta_numeros`

A nova estrutura da tabela é a seguinte:

```sql
CREATE TABLE roleta_numeros (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  roleta_id TEXT NOT NULL,
  roleta_nome TEXT NOT NULL,
  numero INTEGER NOT NULL CHECK (numero >= 0 AND numero <= 36),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Índices

Para melhorar a performance:

```sql
CREATE INDEX idx_roleta_numeros_roleta_id ON roleta_numeros(roleta_id);
CREATE INDEX idx_roleta_numeros_numero ON roleta_numeros(numero);
CREATE INDEX idx_roleta_numeros_created_at ON roleta_numeros(created_at);
```

## Arquivos Atualizados

1. **app.py**: Modificado para trabalhar com a nova estrutura da tabela
   * Adicionada função `obter_ultimos_numeros` para recuperar números da tabela `roleta_numeros`
   * Adicionada função `inserir_novo_numero` para inserir números individuais
   * Atualização do loop principal de scraping

2. **migrate_to_new_table.py**: Transformado em uma ferramenta para inserção manual de números
   * Permite inserir dados de exemplo para teste
   * Suporta inserção manual de números para uma roleta específica

3. **create-roleta-numeros-table.sql**: Script SQL para criar a nova tabela
   * Removida restrição de chave estrangeira
   * Mantido o trigger para limitar registros

4. **requirements.txt**: Atualizadas as dependências do projeto

## Como Usar o Scraper Atualizado

### Criação da Tabela

Execute o script SQL `create-roleta-numeros-table.sql` no seu banco de dados Supabase:

```bash
# Acesse o SQL Editor no painel da Supabase e execute o conteúdo do arquivo create-roleta-numeros-table.sql
```

### Executando o Scraper

O processo de execução permanece o mesmo:

```bash
cd backend/scraper
python app.py
```

O scraper agora armazenará os números diretamente na tabela `roleta_numeros`.

### Inserindo Dados de Teste

Para inserir dados de teste ou números manualmente:

```bash
cd backend/scraper
python migrate_to_new_table.py
```

Siga as instruções do menu para inserir números de exemplo ou manualmente para uma roleta específica.

## Consultas Úteis

### Obter os últimos 10 números de uma roleta específica:

```sql
SELECT numero, created_at 
FROM roleta_numeros 
WHERE roleta_id = '2341648' 
ORDER BY created_at DESC 
LIMIT 10;
```

### Contar ocorrências de cada número para uma roleta:

```sql
SELECT numero, COUNT(*) as ocorrencias 
FROM roleta_numeros 
WHERE roleta_id = '2341648' 
GROUP BY numero 
ORDER BY ocorrencias DESC;
```

### Verificar quantos números cada roleta tem armazenados:

```sql
SELECT roleta_nome, COUNT(*) as total 
FROM roleta_numeros 
GROUP BY roleta_id, roleta_nome;
```

## Benefícios da Nova Estrutura

1. **Consultas Mais Eficientes**: A estrutura relacional permite consultas mais rápidas e específicas.
2. **Melhor Organização de Dados**: Cada número é um registro independente com seu próprio timestamp.
3. **Escalabilidade**: O sistema agora suporta melhor o crescimento contínuo dos dados.
4. **Limitação Automática**: O trigger garante que a tabela não cresça indefinidamente.
5. **Análises Facilitadas**: Estatísticas e padrões podem ser calculados diretamente com SQL. 